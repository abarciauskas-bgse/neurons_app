<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
    <style>

    body {
      font: 10px sans-serif;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .dot {
      stroke: #000;
      opacity: 0;
    }

    .dot-active {
      opacity: 1;
    }

    .area {
        fill: lightsteelblue;
        stroke-width: 0;
        opacity: 0.5;
    }

    #container {
        width: 1024px;
        display: block;
        margin: 0px auto;
    }

    #controls {
        position: relative;
        display: block;
        height: 32px;
        width: 110px;
    }

    .fa.player-icons {
        font-size: 18px;
        color: #333;
        margin-right: 10px;
        position: absolute;
        bottom: 6px;
    }

    .fa.player-icons.icon-lrg {
        font-size: 32px;
        bottom: 0px;
    }    


    </style>
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>

<body>
    <div id="container">
        <div id='controls'>
            <i class="fa fa-repeat player-icons" style="left:0px" id="refresh-button"></i>
            <i class="fa fa-play player-icons icon-lrg" style="left: 28px" id="play-button"></i>
            <i class="fa fa-pause player-icons" style="left: 60px" id="pause-button"></i>
            <i class="fa fa-step-forward player-icons" style="left: 90px" id="step-button"></i>
        </div>
    </div>
</body>

<footer>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="javascripts/rbinom.js"></script>
<script src="javascripts/randoms.js"></script>
<script src="javascripts/step.js"></script>
<script src="javascripts/draw_plot.js"></script>
<script src="javascripts/shade_plot.js"></script>
<script src="javascripts/update_functions.js"></script>
<script>
    // LAYOUT
    var golden_ratio = 1.618,
        width = 1024,
        total_height = 768, // height of whole container
        height1 = total_height/golden_ratio,
        height2 = height1/golden_ratio; // height of lower container, with scatter plots

    var svg = d3.select("#container").append("svg")
        .attr("width", width)
        .attr("height", total_height)
      .append("g")

    // DATA PLOTS
    var first_plot_group = svg.append("g")
        .attr("id", "first_plot_group")
        .attr("transform", "translate(28," + 20 + ")")
    var second_plot_group = svg.append("g")
        .attr("id", "second_plot_group")
        .attr("transform", "translate(" + (height2+50) + "," + 20 + ")")

    // LOSS PLOT
    var loss_memory = 100
    var short_term_regrets = new Array(loss_memory).fill(0.0)
    var losses_plot_group = svg.append("g")
        .attr("id", "losses_plot_group")
        .attr("transform", "translate(" + (height2+50)*2 + "," + 20 + ")")
    var loss_xrange = [0,height2]
    var loss_yrange = [0,height2]
    // xscale
    var loss_xscale = d3.scale.linear().range([loss_xrange[0], loss_xrange[1]]);
    // yscale
    var loss_yscale = d3.scale.linear().range([loss_yrange[1], loss_yrange[0]]);

    loss_xscale.domain([0, short_term_regrets.length]);
    loss_yscale.domain([0, 1]);
    var loss_line_function = d3.svg.line()
            .x(function(d, i) { return loss_xscale(i) })
            .y(function(d, i) { return loss_yscale(d) })


    // Constants
    var eta = 1
    var n = 100 // number of training points
    var scale = 3 // scale of data, -scale to scale
    var max_iters = 100
    var step_duration = 200
    var timeouts = [];
    var current_iter = 0;

    var reset = function(update) {
        // Step 0: Simulate traning data
        var wts = runifo(2, 3) // will be the true weights
        var data = simulate_training_data(wts, eta, n, scale)
        var short_term_regrets = new Array(loss_memory).fill(0.0)
        losses_plot_group.selectAll('path').remove();
        // update plots
        draw_plot([0,height2], [0,height2], 'data', data, first_plot_group, 'dot dot-active', update ? true : false)
        draw_plot([0,height2], [0,height2], 'data', data, second_plot_group, 'dot', update ? true : false)
        draw_plot(loss_xrange, loss_yrange, 'loss', short_term_regrets, losses_plot_group, update ? true : false)

        second_plot_group.selectAll('.area').remove();

        // Step 1: initialization
        var weights = runifo(2,3)
        var points = d3.selectAll('#second_plot_group .dot')[0]
        var long_term_regrets = []
        var all_weights = []
        
        // Step 2: Iterate
        for (var iter = 0; iter < max_iters; iter ++) {
          for (var i = 0; i < n-1; i ++) {
              point = data[i]        
              res = step(point, weights)
              all_weights.push(res.weights)
              weights = res.weights
              long_term_regrets.push(res.loss)
          }
        }

        return {all_weights: all_weights, short_term_regrets: short_term_regrets, long_term_regrets: long_term_regrets}
    }

    var play = function() {
        for (var iter = 0; iter < max_iters*n; iter++) {
            current_iter += 1
            timeouts.push(
                setTimeout(function(i) {
                    step_update(i, short_term_regrets, all_weights, long_term_regrets)
                }, step_duration*iter, current_iter)
            );
        }
    }

    // Controls
    d3.select('#play-button').on("click", function() {play()});
    d3.select('#pause-button').on("click", function() {
        for (var i = 0; i < timeouts.length; i++) {
            clearTimeout(timeouts[i]);
        }
        //quick reset of the timer array you just cleared
        timeouts = [];        
    });
    d3.select("#step-button").on("click", function() {
        current_iter += 1
        step_update(current_iter, short_term_regrets, all_weights, long_term_regrets)
    })
    // do more here to clear the data and regenerate it
    d3.select('#refresh-button').on("click", function() {
        current_iter = 0;
        new_data = reset(true);
        short_term_regrets = new_data.short_term_regrets;
        long_term_regrets = new_data.long_term_regrets;
        all_weights = new_data.all_weights;

        for (var i = 0; i < timeouts.length; i++) {
            clearTimeout(timeouts[i]);
        }
        //quick reset of the timer array you just cleared
        timeouts = [];        
    });

    // first time setup
    var initial_data = reset(false);
    var short_term_regrets = initial_data.short_term_regrets;
    var long_term_regrets = initial_data.long_term_regrets;
    var all_weights = initial_data.all_weights;

</script>
</footer>
</html>
